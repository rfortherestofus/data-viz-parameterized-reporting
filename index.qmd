---
title: "How to Make a Thousand Plots Look Good: Data Viz Tips for Parameterized Reporting"
format:
  rfortherestofus-slides-revealjs:
    menu: false
    progress: false
    slide-number: true
    show-slide-number: print
    center: true
    incremental: true
    auto-animate: true
execute: 
  message: false
  warning: false
  cache: true
knitr:
  opts_chunk:
    dev: "ragg_png"
    dpi: 150
    out.width: 100%
title-slide-attributes:
  data-background-image: assets/rru-hex-bg-gradient-dark.svg
  data-background-size: cover
params:
  country: "Afghanistan"
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(scales)
library(patchwork)
library(ggfx)
library(sf)
library(ggchicklet)
library(ggtext)
library(qrcode)
library(gapminder)
```

# Follow Along! {.center-slide}

```{r}
# qr_code("https://rfor.us/cascadia2024") |>
#   generate_svg("assets/qrcode.svg",
#                background = "transparent",
#                show = FALSE)
```

![](assets/qrcode.svg)

https://rfor.us/cascadia2024


::: {.notes}
- Who I am
- Who R for the Rest of Us is
:::

---


![](assets/obtn-overview.png)

---

![](assets/psc-overview.png)

---

![](assets/ia2030-overview.png)

---

![](assets/cwp-overview.png)

::: {.notes}
- Giving a talk on report design at posit::conf
:::


# What is Parameterized Reporting? {background-image="assets/books.jpg" .inverse}

---

![](assets/parameterized-reporting-1.png)

---

![](assets/parameterized-reporting-2.png)

---

![](assets/parameterized-reporting-3.png)

---

![](assets/parameterized-reporting-4.png)

---

![](assets/parameterized-reporting-5.png)

---

![](assets/parameterized-reporting-6.png)

---

![](assets/parameterized-reporting-7.png)

## How Parameterized Reporting Works {background-image="assets/machine.jpg" background-position="top" .inverse}

---

```{yaml}
#| echo: true
#| eval: false
#| code-line-numbers: "4-5"
---
title: "My report"
format: html
params:
  country: "Afghanistan"
---
```

. . .


```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "5"
library(tidyverse)
library(gapminder)

gapminder |>
  filter(country == params$country) |>
  ggplot(aes(
    x = year,
    y = lifeExp
  )) +
  geom_line()
```

. . .

```{r}
#| fig-height: 3

gapminder |>
  filter(country == params$country) |>
  ggplot(aes(
    x = year,
    y = lifeExp
  )) +
  geom_line() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14)
  )
```

---

```{yaml}
#| echo: true
#| eval: false
#| code-line-numbers: "4-5"
---
title: "My report"
format: html
params:
  country: "Albania"
---
```

. . .


```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "2"
gapminder |>
  filter(country == params$country) |>
  ggplot(aes(
    x = year,
    y = lifeExp
  )) +
  geom_line()
```

. . .

```{r}
#| fig-height: 3

gapminder |>
  filter(country == "Albania") |>
  ggplot(aes(
    x = year,
    y = lifeExp
  )) +
  geom_line() +
  theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 14)
  )
```

::: {.notes}
I'm not going to show parameters throughout, but just know that's how this would work in reality
:::


# Data Viz Tips for Parameterized Reporting {background-image="assets/pencils.jpg" .inverse}

::: {.notes}

:::

# There is No Magic Package {background-image="assets/magic-package.jpg" .inverse}

::: {.notes}
You've got to think deeply about your data

There are packages to help with all of this, but nothing that can help you avoid thinking about your data

With parameterized reporting data viz the big thing is everything that is in your data is unknown until you generate all reports
:::




# Consider the Outer Limits of Your Data {background-image="assets/outer-limits.jpg" .inverse}

::: {.notes}
Give example of Aaron Williams talking about using states with longest and shortest names when making parameterized reports
:::


---

![](assets/obtn-multnomah-race-ethnicity.png)

::: {.notes}
Set limits as 100% when working with percent data
:::

```{r}
# obtn::obtn_race_ethnicity |>
#   filter(year == 2023) |>
#   filter(geography %in% obtn::obtn_oregon_counties) |>
#   select(geography:value) |>
#   rename(
#     "county" = "geography",
#     "pct" = "value"
#   ) |>
#   mutate(pct_formatted = percent(pct, 0.1)) |>
#   mutate(population = fct_rev(population)) |>
#   write_rds("data/obtn_race_ethnicity.rds")
```

---

![](assets/obtn-race-ethnicity.png)

```{r}
race_ethnicity <-
  read_rds("data/obtn_race_ethnicity.rds") |>
  arrange(county)
```

---

```{r}
#| echo: true
race_ethnicity
```

. . .

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "3"
race_ethnicity_bar_chart <- function(county_to_plot) {
  race_ethnicity |>
    filter(county == county_to_plot) |>
    ggplot(
      aes(
        x = pct,
        y = population
      )
    ) +
    geom_col(fill = "#004f39") +
    ...
}
```


---

```{r}
race_ethnicity_bar_chart <- function(county_to_plot) {
  obtn_race_ethnicity_filtered <-
    race_ethnicity |>
    filter(county == county_to_plot)

  obtn_race_ethnicity_filtered |>
    ggplot(
      aes(
        x = pct,
        y = population
      )
    ) +
    geom_col(fill = "#004f39") +
    geom_text(
      data = obtn_race_ethnicity_filtered |> filter(population == "White"),
      aes(
        label = pct_formatted
      ),
      color = "white",
      hjust = 1.1,
      size = 6
    ) +
    scale_x_continuous(
      expand = expansion(0, 0)
    ) +
    labs(title = county_to_plot) +
    theme_void() +
    theme(
      plot.title = element_text(
        size = 20,
        face = "bold"
      ),
      plot.margin = margin(rep(10, 4))
    )
}
```


```{r}
#| echo: true
#| eval: false
race_ethnicity_bar_chart(county_to_plot = "Multnomah")
```

. . .

```{r}
race_ethnicity_bar_chart(county_to_plot = "Multnomah")
```

---

```{r}
#| echo: true
#| fig-height: 3
race_ethnicity_bar_chart(county_to_plot = "Multnomah")
```

. . .

```{r}
#| echo: true
#| fig-height: 3
race_ethnicity_bar_chart(county_to_plot = "Baker")
```

---

![](assets/obtn-multnomah-race-ethnicity.png)


---

```{r}
#| echo: true
#| output: false
#| code-line-numbers: "2-9"
race_ethnicity_bar_chart(county_to_plot = "Multnomah") +
  geom_col(
    aes(
      x = 1
    ),
    fill = "transparent",
    color = "#A9C27F",
    linetype = "dotted"
  )
```


---

```{r}
#| fig-height: 3.25
race_ethnicity_bar_chart(county_to_plot = "Multnomah") +
  geom_col(
    aes(
      x = 1
    ),
    fill = "transparent",
    color = "#A9C27F",
    linetype = "dotted"
  )
```

. . .

```{r}
#| fig-height: 3.25
race_ethnicity_bar_chart(county_to_plot = "Baker") +
  geom_col(
    aes(
      x = 1
    ),
    fill = "transparent",
    color = "#A9C27F",
    linetype = "dotted"
  )
```


---

![](assets/obtn-multnomah-median-income.png)

::: {.notes}
Set limits of plot based on max of all data
:::

```{r}
median_income <- read_csv("data/median_income.csv") |>
  rename("amount" = "value") |>
  mutate(amount_formatted = dollar(amount, 1)) |>
  select(geography, year, amount, amount_formatted) |>
  filter(year == 2024)

oregon_counties <-
  median_income |>
  distinct(geography) |>
  filter(!geography %in% c("Oregon", "Rural", "Urban")) |>
  pull(geography)
```

```{r}
median_income_plot <- function(county_to_plot) {
  median_income |>
    filter(geography %in% c(county_to_plot, "Oregon")) |>
    mutate(geography = fct(geography, levels = c("Oregon", county_to_plot))) |>
    ggplot(
      aes(
        x = amount,
        y = geography,
        label = amount_formatted,
        fill = geography
      )
    ) +
    geom_col(show.legend = FALSE) +
    geom_text(
      color = "white",
      hjust = 1.2,
      size = 16
    ) +
    geom_text(
      aes(
        x = 2000,
        label = geography
      ),
      color = "white",
      hjust = 0,
      size = 16
    ) +
    scale_fill_manual(values = c(
      "gray",
      "darkgreen"
    )) +
    theme_void() +
    theme(plot.margin = margin(rep(20, 4)))
}
```

---

```{r}
#| echo: true
median_income
```

. . .

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "3"
median_income_plot <- function(county_to_plot) {
  median_income |>
    filter(geography %in% c(county_to_plot, "Oregon")) |>
    ggplot(
      aes(
        x = amount,
        y = geography,
        label = amount_formatted,
        fill = geography
      )
    ) +
    geom_col() +
    ...
}
```



---

```{r}
#| eval: false
#| echo: true
median_income_plot(county_to_plot = "Jackson")
```

. . .

```{r}
#| fig-height: 3
#| fig-width: 20
median_income_plot(county_to_plot = "Jackson")
```

---

```{r}
#| fig-height: 3
#| fig-width: 20
median_income_plot(county_to_plot = "Jackson")
```

. . .

```{r}
#| fig-height: 3
#| fig-width: 20
median_income_plot(county_to_plot = "Harney")
```

. . .

```{r}
#| fig-height: 3
#| fig-width: 20
median_income_plot(county_to_plot = "Washington")
```


---

```{r}
#| echo: true
max_median_income <-
  median_income |>
  slice_max(
    order_by = amount,
    n = 1
  ) |>
  pull(amount)
```

. . .

```{r}
#| echo: true
max_median_income
```

---


```{r}
#| eval: false
#| echo: true
#| code-line-numbers: "2-4"
median_income_plot(county_to_plot = "Jackson") +
  scale_x_continuous(
    limits = c(0, max_median_income)
  )
```

. . .

```{r}
#| fig-height: 3
#| fig-width: 20
median_income_plot(county_to_plot = "Jackson") +
  scale_x_continuous(
    limits = c(0, max_median_income)
  )
```


---

```{r}
#| fig-height: 3
#| fig-width: 20
median_income_plot(county_to_plot = "Jackson") +
  scale_x_continuous(
    limits = c(0, max_median_income)
  )
```

. . .

```{r}
#| fig-height: 3
#| fig-width: 20
median_income_plot(county_to_plot = "Harney") +
  scale_x_continuous(
    limits = c(0, max_median_income)
  )
```

. . .

```{r}
#| fig-height: 3
#| fig-width: 20
median_income_plot(county_to_plot = "Washington") +
  scale_x_continuous(
    limits = c(0, max_median_income)
  )
```


# Minimize Text and Position it Carefully {background-image="assets/erase-text.jpg" .inverse}

```{r}
library(palmerpenguins)

set.seed(1234)
```


::: {.notes}
Text WILL overlap so think proactively about how to avoid it

The problem is, you never know how it will look for all of your plots

Here's the problem with text
:::

## Don't Try to Label Everything {background-image="assets/label.jpg" .inverse}

---

![](assets/psc-population-projection.png)

---

```{r}
# pschousing::data_population_projection |>
#   select(area_name:age_cohort_grp, perc_proj) |>
#   rename(
#     "location" = "area_name",
#     "age_group" = "age_cohort_grp",
#     "pct" = "perc_proj"
#   ) |>
#   mutate(pct_formatted = percent(pct, 1)) |>
#   write_rds("data/population_projection.rds")
```


```{r}
population_projection <-
  read_rds("data/population_projection.rds")
```

```{r}
#| echo: true
population_projection |>
  filter(location == "Hartford")
```

. . .

```{r}
#| echo: true
#| eval: false
population_projection_plot <- function(town_to_plot, county_to_plot) {
  population_projection |>
    filter(location %in% c(town_to_plot, county_to_plot, "Connecticut")) |>
    ggplot(aes(
      x = year,
      y = pct,
      color = location,
      group = location
    )) +
    geom_point() +
    geom_line() +
    ...
}
```

---

```{r}
population_projection_plot <- function(town_to_plot, county_to_plot) {
  population_projection |>
    filter(location %in% c(town_to_plot, county_to_plot, "Connecticut")) |>
    mutate(location = fct(
      location,
      levels = c("Connecticut", county_to_plot, town_to_plot)
    )) |>
    ggplot(aes(
      x = year,
      y = pct,
      color = location,
      group = location
    )) +
    geom_point(size = 2) +
    geom_line(show.legend = FALSE) +
    labs(color = NULL) +
    facet_wrap(
      vars(age_group),
      nrow = 1
    ) +
    scale_y_continuous(
      limits = c(0, 0.4),
      labels = percent_format(1)
    ) +
    scale_color_manual(
      values = c(
        # town_to_plot = "#9f3515",
        # county_to_plot = "#fbbfb8",
        # "Connecticut" = "#c4c4c4"
        "#c4c4c4",
        "#fbbfb8",
        "#9f3515"
      )
    ) +
    guides(color = guide_legend(reverse = TRUE)) +
    theme_minimal() +
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_blank(),
      legend.position = "bottom",
      strip.text = element_text(
        face = "italic",
        size = 13,
        color = "grey40"
      ),
      legend.text = element_text(
        size = 13,
        color = "grey40"
      ),
      axis.title = element_blank(),
      axis.text = element_text(
        size = 13,
        color = "grey40"
      )
    )
}
```

```{r}
#| echo: true
#| eval: false
population_projection_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
)
```

. . .

```{r}
population_projection_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
)
```

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "5-9"
population_projection_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
) +
  geom_text(
    aes(
      label = pct_formatted
    )
  )
```

. . .

```{r}
#| fig-height: 4
population_projection_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
) +
  geom_text(
    aes(
      label = pct_formatted
    ),
    size = 6,
    show.legend = FALSE
  )
```

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "5-9"
population_projection_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
) +
  geom_text_repel(
    aes(
      label = pct_formatted
    )
  )
```

. . .

```{r}
#| fig-height: 4
population_projection_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
) +
  geom_text_repel(
    aes(
      label = pct_formatted
    ),
    size = 6,
    show.legend = FALSE
  )
```

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "6,7"
population_projection_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
) +
  geom_text(
    data = population_projection |> filter(location == "Hartford"),
    nudge_y = 0.03,
    aes(
      label = pct_formatted
    )
  )
```

. . .

```{r}
#| fig-height: 4
population_projection_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
) +
  geom_text(
    data = population_projection |> filter(location == "Hartford"),
    nudge_y = 0.03,
    aes(
      label = pct_formatted
    ),
    size = 6,
    show.legend = FALSE
  )
```

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "6"
population_projection_plot(
  town_to_plot = "Stamford",
  county_to_plot = "Fairfield County"
) +
  geom_text(
    data = population_projection |> filter(location == "Stamford"),
    nudge_y = 0.03,
    aes(
      label = pct_formatted
    )
  )
```

. . .

```{r}
#| fig-height: 4
population_projection_plot(
  town_to_plot = "Stamford",
  county_to_plot = "Fairfield County"
) +
  geom_text(
    data = population_projection |> filter(location == "Stamford"),
    nudge_y = 0.03,
    aes(
      label = pct_formatted
    ),
    size = 6,
    show.legend = FALSE
  )
```

---

```{r}
library(shadowtext)
```


```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "1,7,9"

library(shadowtext)

population_projection_plot(
  town_to_plot = "Stamford",
  county_to_plot = "Fairfield County"
) +
  geom_shadowtext(
    data = population_projection |> filter(location == "Stamford"),
    bg.color = "white",
    nudge_y = 0.03,
    aes(
      label = pct_formatted
    )
  )
```

. . .

```{r}
#| fig-height: 4
population_projection_plot(
  town_to_plot = "Stamford",
  county_to_plot = "Fairfield County"
) +
  geom_shadowtext(
    data = population_projection |> filter(location == "Stamford"),
    bg.color = "white",
    nudge_y = 0.03,
    aes(
      label = pct_formatted
    ),
    size = 6,
    show.legend = FALSE
  )
```



## Hide Small Values {background-image="assets/small-numbers.jpg" .inverse}


---

![](assets/psc-housing-cost-burden.png)

---

```{r}
# pschousing::data_acs$affordability_occupancy_status |>
#   filter(occupancy_status == "Renter") |>
#   select(area_name, spending_to_income_grp, perc_spending) |>
#   rename(
#     "location" = "area_name",
#     "burden_level" = "spending_to_income_grp",
#     "pct" = "perc_spending"
#   ) |>
#   mutate(pct_formatted = percent(pct, 1)) |>
#   mutate(burden_level = fct_collapse(
#     burden_level,
#     "Not burdened" = "Not experiencing a burden (<30%)",
#     "Moderate burden" = "Cost-burdened (30%-50%)",
#     "Severe burden" = "Severely cost-burdened (>=50%)",
#     "Not computed" = "Not Computed"
#   )) |>
#   mutate(burden_level = fct(
#     as.character(burden_level),
#     levels = c(
#       "Not computed",
#       "Not burdened",
#       "Moderate burden",
#       "Severe burden"
#     )
#   )) |>
#   mutate(location = fct_inorder(location)) |>
#   mutate(location = fct_rev(location)) |>
#   write_rds("data/housing_cost_burden.rds")
```


```{r}
housing_cost_burden <-
  read_rds("data/housing_cost_burden.rds")
```

```{r}
#| echo: true
housing_cost_burden 
```

. . .

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "3"
housing_cost_burden_plot <- function(town_to_plot, county_to_plot) {
  housing_cost_burden |>
    filter(location %in% c(town_to_plot, county_to_plot, "Connecticut")) |>
    ggplot(aes(
      x = pct,
      y = location,
      fill = burden_level,
      label = pct_formatted
    )) +
    geom_col() +
    geom_text(position = position_stack(vjust = 0.5)) +
    ...
}
```

---

```{r}
housing_cost_burden_plot <- function(town_to_plot, county_to_plot) {
  housing_cost_burden |>
    filter(location %in% c(town_to_plot, county_to_plot, "Connecticut")) |>
    ggplot(aes(
      x = pct,
      y = location,
      fill = burden_level,
      color = burden_level,
      label = pct_formatted
    )) +
    geom_col(color = "white") +
    geom_text(
      position = position_stack(vjust = 0.5),
      size = 10,
      fontface = "bold",
    ) +
    scale_fill_manual(
      name = "",
      values = pschousing::psc_colors("grey3", "grey2", "lightblue2", "lightblue"),
      guide = guide_legend(reverse = TRUE)
    ) +
    scale_color_manual(
      values = c("white", "white", "#969696", "white"),
      guide = FALSE
    ) +
    scale_x_continuous(expand = expansion(0, 0.01)) +
    labs(fill = NULL) +
    theme_void(base_size = 16) +
    theme(
      legend.position = "bottom",
      legend.text = element_text(color = "grey40"),
      axis.text.y = element_text(hjust = 1),
      plot.margin = margin(rep(20, 4))
    )
}
```

```{r}
#| echo: true
#| eval: false
housing_cost_burden_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
)
```

. . .

```{r}
housing_cost_burden_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
)
```



---

```{r}
#| echo: true
housing_cost_burden |> 
  filter(location == "Hartford")
```


. . .

```{r}
#| echo: true
#| code-line-numbers: "3"
housing_cost_burden <-
  housing_cost_burden |>
  mutate(pct_formatted = if_else(pct > 0.07, pct_formatted, NA))
```

. . .

```{r}
#| echo: true
housing_cost_burden |>
  filter(location == "Hartford")
```

---

```{r}
#| echo: true
#| eval: false
housing_cost_burden_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
)
```

. . .

```{r}
housing_cost_burden_plot(
  town_to_plot = "Hartford",
  county_to_plot = "Hartford County"
)
```

---

```{r}
#| echo: true
#| eval: false
housing_cost_burden_plot(
  town_to_plot = "Stamford",
  county_to_plot = "Fairfield County"
)
```

. . .

```{r}
housing_cost_burden_plot(
  town_to_plot = "Stamford",
  county_to_plot = "Fairfield County"
)
```




## Don't Put Text Where it Could Be Obscured {background-image="assets/hidden.jpg" background-opacity="0.8" .inverse}

---

![](assets/cwp-pre-post.png)

---

```{r}
pre_post_plot <- function(df) {
  df |>
    ggplot(aes(
      x = rating,
      y = question,
      fill = timing,
      label = rating,
      group = question
    )) +
    geom_vline(
      xintercept = 1:5,
      color = "grey90"
    ) +
    geom_line(
      color = "grey70",
      alpha = 0.75,
      linewidth = 1.5
    ) +
    geom_point(
      shape = 21,
      color = "white",
      size = 14,
      stroke = 2
    ) +
    scale_x_continuous(
      limits = c(1, 5),
      breaks = seq(1, 5, 1),
      position = "top",
      expand = expansion(0, 0)
    ) +
    scale_color_manual(
      values = c(
        "Pre" = "#6d8d24",
        "Post" = "#213921"
      )
    ) +
    scale_fill_manual(
      values = c(
        "Pre" = "#6d8d24",
        "Post" = "#213921"
      ),
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      title = "Consider the limits of your data",
      fill = NULL
    ) +
    theme_minimal(base_size = 16) +
    theme(
      plot.margin = margin(rep(20, 4)),
      axis.title = element_blank(),
      panel.grid = element_blank(),
      # plot.title = element_text(face = "bold",
      #                           color = "grey30"),
      plot.title = element_blank(),
      plot.title.position = "plot",
      legend.position = "none",
      axis.text.x = element_text(
        color = "grey40",
        size = 12
      ),
      axis.text.y = element_text(
        color = "grey40",
        size = 12
      )
    )
}
```


```{r}
pre_post_data <-
  tribble(
    ~question,
    ~timing,
    ~rating,
    "Consider the limits of your data",
    "Pre",
    1.6,
    "Consider the limits of your data",
    "Post",
    4.2
  ) |>
  mutate(
    growth = rating - lag(rating, 1),
    growth = if_else(timing == "Post", growth, NA),
    growth_formatted = number(growth, 0.1),
    growth_formatted = str_glue("+{growth_formatted}"),
    growth_formatted = if_else(timing == "Post", growth, NA),
    growth_text_position = rating - growth / 2
  )
```

```{r}
#| echo: true
pre_post_data
```

. . .

```{r}
#| echo: true
#| eval: false

pre_post_plot <- function(df) {
  df |>
    ggplot(aes(
      x = rating,
      y = question,
      fill = timing
    )) +
    geom_line() +
    geom_point(shape = 21) +
    ...
}
```


---

```{r}
#| echo: true
#| eval: false
pre_post_data |>
  pre_post_plot()
```

. . .

```{r}
#| fig-height: 2
pre_post_data |>
  pre_post_plot()
```


---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: 3-7|8-14|15-21
pre_post_data |>
  pre_post_plot() +
  # Ratings within points
  geom_text(
    aes(label = rating),
    color = "white"
  ) +
  # Pre/post labels
  geom_text(
    aes(
      label = timing,
      color = timing
    )
  ) +
  # Growth label
  geom_text(
    aes(
      x = growth_text_position,
      label = growth_formatted
    )
  )
```

. . .

```{r}
#| fig-height: 2
pre_post_data |>
  pre_post_plot() +
  geom_text(
    color = "white",
    size = 5
  ) +
  geom_text(
    aes(
      label = timing,
      color = timing
    ),
    size = 5,
    vjust = -2,
    fontface = "bold"
  ) +
  geom_text(
    aes(
      x = rating - growth / 2,
      label = growth_formatted
    ),
    size = 5,
    vjust = -1
  )
```

---

```{r}
pre_post_data <-
  tribble(
    ~question,
    ~timing,
    ~rating,
    "Consider the limits of your data",
    "Pre",
    3.5,
    "Consider the limits of your data",
    "Post",
    3.6
  ) |>
  mutate(
    growth = rating - lag(rating, 1),
    growth = if_else(timing == "Post", growth, NA),
    growth_formatted = number(growth, 0.1),
    growth_formatted = str_glue("+{growth_formatted}"),
    growth_formatted = if_else(timing == "Post", growth, NA),
    growth_text_position = rating - growth / 2
  )
```

```{r}
#| echo: true
pre_post_data
```

. . .


```{r}
#| fig-height: 2
pre_post_data |>
  pre_post_plot() +
  geom_text(
    color = "white",
    size = 5
  ) +
  geom_text(
    aes(
      label = timing,
      color = timing
    ),
    size = 5,
    vjust = -2,
    fontface = "bold"
  ) +
  geom_text(
    aes(
      x = growth_text_position,
      label = growth_formatted
    ),
    size = 5,
    vjust = -1
  )
```

---

```{r}
#| echo: true
#| code-line-numbers: 3-6
pre_post_data <-
  pre_post_data |>
  mutate(rating_text_position = case_when(
    timing == "Pre" ~ rating - 0.3,
    timing == "Post" ~ rating + 0.3
  ))
```

. . .

```{r}
#| echo: true
pre_post_data |>
  select(question, timing, rating, rating_text_position)
```

. . .

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: 3-8|9-14
pre_post_data |>
  pre_post_plot() +
  geom_text(
    aes(
      x = rating_text_position,
      label = rating
    )
  ) +
  geom_text(
    aes(
      x = rating_text_position,
      label = timing
    )
  ) +
  ...
```

---

```{r}
#| echo: true
#| eval: false
pre_post_data |>
  pre_post_plot() +
  geom_text(
    aes(
      x = rating_text_position,
      label = rating
    )
  ) +
  geom_text(
    aes(
      x = rating_text_position,
      label = timing
    )
  ) +
  ...
```


```{r}
#| fig-height: 2
pre_post_data |>
  pre_post_plot() +
  geom_text(
    aes(
      x = rating_text_position,
      color = timing
    ),
    size = 5,
    fontface = "bold"
  ) +
  geom_text(
    aes(
      x = rating_text_position,
      label = timing,
      color = timing
    ),
    size = 5,
    vjust = -2,
    fontface = "bold"
  ) +
  geom_text(
    aes(
      x = rating - growth / 2,
      label = growth_formatted
    ),
    size = 5,
    vjust = -1
  )
```

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: 3-8
pre_post_data |>
  pre_post_plot() +
  geom_label(
    aes(
      x = 6,
      label = growth_formatted
    )
  ) +
  ...
```

. . .

```{r}
#| fig-height: 2
pre_post_data |>
  mutate(rating_text_position = case_when(
    timing == "Pre" ~ rating - 0.3,
    timing == "Post" ~ rating + 0.3
  )) |>
  pre_post_plot() +
  geom_text(
    aes(
      x = rating_text_position,
      color = timing
    ),
    fontface = "bold",
    size = 5
  ) +
  geom_text(
    aes(
      x = rating_text_position,
      label = timing,
      color = timing
    ),
    vjust = -2,
    fontface = "bold",
    size = 5
  ) +
  geom_label(
    aes(
      x = 6,
      label = growth_formatted
    ),
    fill = "#cfd82d",
    label.size = unit(0, "pt"),
    label.padding = unit(4, "pt"),
    label.r = unit(3, "pt"),
    color = "grey30",
    fontface = "bold",
    size = 5
  ) +
  scale_x_continuous(
    position = "top",
    limits = c(1, 6),
    breaks = c(
      1,
      2,
      3,
      4,
      5,
      6
    ),
    labels = c(
      "1",
      "2",
      "3",
      "4",
      "5",
      "Growth"
    )
  )
```


# Highlight Strategically and Programatically {background-image="assets/highlight.jpg" .inverse}

::: {.notes}
TODO: Talk about how I'm adding layers on top of other layers here (make diagram)
:::

---


::: {.rainbow}
Color
:::

. . .

::: {.giant-text}
Size
:::

. . .

::: {.shadow-text}
Shadow
:::

. . .

::: {.outline-text}
Outline
:::

. . .

::: {.opacity-text}
Opacity
:::


## Color {background-image="assets/color.jpg" .inverse}

---

![](assets/psc-single-family-homes.png)


---

```{r}
# pschousing::data_acs$units_structure_occupancy_status |>
#   filter(area_level == "Town") |>
#   group_by(area_name, units_structure_grp) |>
#   summarize(total = sum(estimate)) |>
#   mutate(pct = total / sum(total, na.rm = TRUE)) |>
#   ungroup() |>
#   filter(units_structure_grp == "Single-Family") |>
#   select(area_name, pct) |>
#   rename("location" = "area_name") |>
#   write_rds("data/single_family_homes.rds")
```

```{r}
single_family_homes <-
  read_rds("data/single_family_homes.rds")
```

```{r}
#| echo: true
single_family_homes
```

. . .

```{r}
#| echo: true
#| eval: false
single_family_homes_plot <- function() {
  single_family_homes |>
    ggplot(
      aes(
        x = pct,
        y = 1
      )
    ) +
    geom_point(
      shape = 124,
      color = "grey80"
    ) +
    ...
}
```


---



```{r}
single_family_homes_plot <- function() {
  single_family_homes |>
    ggplot(
      aes(
        x = pct,
        y = 1
      )
    ) +
    geom_hline(
      yintercept = 1,
      color = "grey90",
      linewidth = 0.25
    ) +
    geom_point(
      shape = 124,
      color = "grey80",
      size = 5
    ) +
    # scale_color_manual(
    #   values = c(
    #     "Y" = "#15397f",
    #     "N" = "grey80"
    #   )
    # ) +
    # scale_size_manual(values = c(
    #   "Y" = 15,
    #   "N" = 5
    # )) +
    scale_x_continuous(
      labels = percent_format(accuracy = 1),
      breaks = seq(0, 1, 0.25)
    ) +
    expand_limits(
      x = 0
    ) +
    theme_void() +
    theme(
      axis.text.x = element_text(
        size = 13,
        color = "grey40"
      ),
      legend.position = "none",
      plot.margin = margin(rep(20, 4))
    )
}
```

```{r}
#| echo: true
#| eval: false
single_family_homes_plot()
```

. . .

```{r}
#| fig-height: 2
single_family_homes_plot()
```


---


```{r}
#| echo: true
#| eval: false
single_family_homes_plot() +
  geom_point(
    data = single_family_homes |> filter(location == "Hartford"),
    shape = 124,
    color = "#15397f"
  )
```

. . .

```{r}
#| fig-height: 2
single_family_homes_plot() +
  geom_point(
    data = single_family_homes |> filter(location == "Hartford"),
    shape = 124,
    color = "#15397f",
    size = 5
  )
```


## Size {background-image="assets/size.jpg" background-position="top" .inverse}

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "6"
single_family_homes_plot() +
  geom_point(
    data = single_family_homes |> filter(location == "Hartford"),
    shape = 124,
    color = "#15397f",
    size = 15
  )
```

. . .

```{r}
#| fig-height: 2
single_family_homes_plot() +
  geom_point(
    data = single_family_homes |> filter(location == "Hartford"),
    shape = 124,
    color = "#15397f",
    size = 15
  )
```

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "3"
single_family_homes_plot() +
  geom_point(
    data = single_family_homes |> filter(location == "Stamford"),
    shape = 124,
    color = "#15397f",
    size = 15
  )
```

. . .

```{r}
#| fig-height: 2
single_family_homes_plot() +
  geom_point(
    data = single_family_homes |> filter(location == "Stamford"),
    shape = 124,
    color = "#15397f",
    size = 15
  )
```



## Shadow {background-image="assets/shadow.jpg" .inverse}

---

![](assets/ia2030-region-map.png)

---

```{r}
# read_rds("data/sf_region_ig1_2_map.rds") |>
#   select(country_name, ind_region, disease, status) |>
#   rename(
#     "country" = "country_name",
#     "region" = "ind_region"
#   ) |>
#   filter(disease == "Rubella") |>
#   # select(-disease) |>
#   write_rds("data/rubella.rds")

rubella <- read_rds("data/rubella.rds")

ia2030_colors <- list(
  navy = "#1f4675",
  light_blue = "#59b8cd",
  light_blue_back = "#e5f1f8",
  red = "#eb5a53",
  yellow = "#ffd300",
  stone = "#f0eae5",
  light_grey = "#e5ebee",
  # not official
  green = "#43a047",
  dark_grey = "#353535"
)

region_map <- function(opacity_level = 1) {
  ggplot() +
    geom_sf(
      data = rubella |>
        filter(region == 1) |>
        add_row(status = "Achieved", disease = "Rubella") |>
        add_row(status = "Re-established", disease = "Rubella") |>
        add_row(status = "Not achieved", disease = "Rubella") |>
        add_row(status = "No data", disease = "Rubella") |>
        mutate(status = fct(
          status,
          levels = c(
            "Achieved",
            "Re-established",
            "Not achieved",
            "No data"
          )
        )),
      aes(fill = status),
      linewidth = 0.2,
      color = "white",
      alpha = opacity_level
    ) +
    geom_sf(
      data = rubella |>
        filter(region == 0),
      fill = "lightgrey",
      color = "grey",
      linewidth = 0,
      alpha = 0.5
    ) +
    scale_fill_manual(
      name = "",
      values = c(
        "Achieved" = ia2030_colors$navy,
        "Re-established" = ia2030_colors$yellow,
        "Not achieved" = ia2030_colors$red,
        "No data" = ia2030_colors$light_grey
      ),
      drop = FALSE
    ) +
    theme_void() +
    guides(fill = guide_legend(override.aes = list(
      alpha = 1,
      color = "white"
    ))) +
    theme(
      legend.text = element_text(
        size = 12,
        color = "grey40",
        family = "Inter"
      ),
      plot.margin = margin(rep(20, 4)),
      legend.position = "bottom"
    )
}
```

::: {.notes}
Explain how we're not using aesthetic properties here so much as putting another layer on top of existing layers
:::

```{r}
#| echo: true
#| eval: false
rubella
```

```{r}
rubella |>
  select(-disease)
```


. . .

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "3-6|7-11"
region_map <- function() {
  ggplot() +
    geom_sf(
      data = rubella |> filter(region == 1),
      aes(fill = status)
    ) +
    geom_sf(
      data = rubella |> filter(region == 0),
      fill = "lightgrey",
      alpha = 0.5
    ) +
    ...
}
```



---

```{r}
# rubella <- read_rds("data/rubella.rds")
```



```{r}
#| echo: true
region_map()
```


::: {.notes}
https://www.linkedin.com/feed/update/urn:li:activity:7157725182416015360/
:::



---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "1,4-9"
library(ggfx)

region_map() +
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Afghanistan")
    ),
    ...
  )
```

. . .

```{r}
region_map() +
  # shadow for the current country
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Afghanistan"),
      aes(fill = status),
      alpha = 1,
      color = "white",
    ),
    sigma = 0,
    x_offset = 4,
    y_offset = 4
  )
```

## Outline {background-image="assets/outline.jpg" .inverse}

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "6-7"

region_map() +
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Afghanistan")
    ),
    linewidth = 0.8,
    color = "white",
    ...
  )
```

. . .

```{r}
region_map() +
  # shadow for the current country
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Afghanistan"),
      aes(fill = status),
      linewidth = 0.8,
      color = "white",
      alpha = 1
    ),
    sigma = 0,
    x_offset = 4,
    y_offset = 4
  )
```

::: {.notes}
Add outline to make it pop even more
:::


## Opacity {background-image="assets/opacity.jpg" .inverse}

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "6"
region_map <- function() {
  ggplot() +
    geom_sf(
      data = rubella |> filter(region == 1),
      aes(fill = status),
      alpha = 0.75
    ) +
    geom_sf(
      data = rubella |> filter(region == 0),
      fill = "lightgrey",
      alpha = 0.5
    ) +
    ...
}
```


---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "1"
region_map(opacity_level = 0.75) +
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Afghanistan")
    ),
    linewidth = 0.8,
    color = "white",
    ...
  )
```


```{r}
region_map(opacity_level = 0.75) +
  # shadow for the current country
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Afghanistan"),
      aes(fill = status),
      linewidth = 0.8,
      color = "white",
      alpha = 1
    ),
    sigma = 0,
    x_offset = 4,
    y_offset = 4
  )
```

---


```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "1"
region_map(opacity_level = 0.75) +
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Afghanistan")
    ),
    linewidth = 0.8,
    color = "white",
    ...
  )
```

```{r}
region_map(opacity_level = 0.75) +
  # shadow for the current country
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Afghanistan"),
      aes(fill = status),
      linewidth = 0.8,
      color = "white",
      alpha = 1
    ),
    sigma = 0,
    x_offset = 4,
    y_offset = 4
  )
```

---

```{r}
#| echo: true
#| eval: false
#| code-line-numbers: "1"
region_map(opacity_level = 0.75) +
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Iraq")
    ),
    linewidth = 0.8,
    color = "white",
    ...
  )
```


```{r}
region_map(opacity_level = 0.75) +
  # shadow for the current country
  with_shadow(
    geom_sf(
      data = rubella |> filter(country == "Iraq"),
      aes(fill = status),
      linewidth = 0.8,
      color = "white",
      alpha = 1
    ),
    sigma = 0,
    x_offset = 4,
    y_offset = 4
  )
```



# Conclusion

1. Consider the Outer Limits of Your Data

1. Minimize Text and Position it Carefully

1. Highlight Strategically and Programatically with a Range of Aesthetic Properties

::: {.notes}
The solution is less code and more thinking about data
:::
